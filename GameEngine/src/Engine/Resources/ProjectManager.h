#pragma once

#include <string>
#include <vector>
#include <unordered_set>
#include <filesystem>
#include "Engine/core.h"

namespace Engine {

    enum class AssetType { File, Directory, Unknown };

    struct AssetEntry {
        std::string relativePath; // ??? projectRoot
        AssetType type = AssetType::Unknown;
    };

    struct DirEntry {
        std::string name;         // ???/?????????
        std::string relativePath; // ??????????ùù??
        bool isDirectory = false;
        AssetType type = AssetType::Unknown;
    };

    enum class CopyStrategy {
        Skip,      // ?????????????
        Overwrite, // ?????????????
        Rename     // ??????????? (????: file.txt -> file (1).txt)
    };

    struct ImportResult {
        bool success = false;
        std::string message;
        std::string targetPath; // ?????????ùù??
    };

    // ??ùù???????????????????????ùù??????????????????????
    class ProjectManager {
    public:
        ProjectManager();
        static Ref<ProjectManager> Get();

        void SetProjectRoot(const std::string& path);
        const std::string& GetProjectRoot() const { return m_ProjectRoot; }

        // ???????ùù????????ùZ???????????ùù???????
        bool AddFileByBrowse(const std::string& absPath);

        // ??????????????????
        ImportResult CopyFileToProject(const std::string& sourceAbsPath, const std::string& targetRelDir = "", CopyStrategy strategy = CopyStrategy::Rename);
        
        // ?????????????????
        std::vector<ImportResult> CopyDirectoryToProject(const std::string& sourceDirAbsPath, const std::string& targetRelDir = "", CopyStrategy strategy = CopyStrategy::Rename);
        
        // ???????????????ùù???????????????????
        ImportResult ProcessInputPath(const std::string& inputPath);

        // ?ùù??????????????????????????
        std::vector<DirEntry> ListDirectoryContents(const std::string& relativeDir = "") const;

        // ???????ùù???????????????????
        void RefreshAssets();

        const std::vector<AssetEntry>& ListAssets() const { return m_Assets; }

        // ??????????????ùù????????ùù????
        static AssetType ClassifyByExtension(const std::string& extLower);

        // ??????ùù???ùZ???????????? '\' ?? '/'???????????????
        static std::string NormalizePath(const std::string& p);

        // ???? absPath ??? m_ProjectRoot ?????ùù??????????????????
        std::string MakeRelativeToRoot(const std::string& absPath) const;

    private:
        std::string m_ProjectRoot; // ????ùù??
        std::vector<AssetEntry> m_Assets;
        std::unordered_set<std::string> m_AssetDedup; // ????????? relativePath??

        // ????????
        std::string GenerateUniqueFileName(const std::string& targetAbsPath) const;
        bool IsValidTargetPath(const std::string& targetRelPath) const;
        void ScanDirectoryRecursive(const std::string& dirAbsPath, const std::string& relativeBase);
    };
}