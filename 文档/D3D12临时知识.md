## D3D12临时知识







`ID3DBlob` 就是 **DirectX 世界里的标准“搬运工”和“仓库”**。它提供了一种类型安全（通过 `ComPtr`）、内存安全（自动释放）、且与框架高度整合的方式，来在 CPU 上创建和管理通用的二进制数据块，尤其适合用于准备将要上传到 GPU 的资源，或是接收从 API 调用返回的数据（如着色器代码）。





顶点缓冲区的输入槽位与顶点着色器VA的输入签名槽位什么区别

渲染管线有**16个顶点数据槽位**，可以绑定不同的顶点缓冲区，并通过**顶点缓冲区视图指定槽位**。

输入布局描述能够**将输入渲染管线的顶点数据，绑定为顶点着色器参数**。D3D12_INPUT_ELEMENT_DESC描述了顶点数据从哪个槽来，偏移了多少，格式是什么，绑定到哪个顶点着色器参数。



使用两个顶点缓冲区，在输入布局中描述使用哪个顶点槽位，从而让着色器使用不同







##### 结构化缓冲区以及其描述

结构化缓冲区是一种数组型的缓冲区，可以通过索引访问。既可以创建为上传堆也可以是默认堆。创建时，应该通过flag指定是否可以读写。D3D12_RESOURCE_STATE_GENERIC_READ：只读；D3D12_RESOURCE_STATE_UNORDERED_ACCESS随机读写。

```
ThrowIfFailed(device->CreateCommittedResource(
    &CD3DX12_HEAP_PROPERTIES(D3D12_HEAP_TYPE_UPLOAD),
    D3D12_HEAP_FLAG_NONE,
    &CD3DX12_RESOURCE_DESC::Buffer(mElementByteSize*elementCount),
    D3D12_RESOURCE_STATE_GENERIC_READ,
    nullptr,
    IID_PPV_ARGS(&mUploadBuffer)));
```



结构化缓冲区通过srv描述，可以直接使用根描述符绑定。

```
	mCommandList->SetGraphicsRootShaderResourceView(0, instanceBuffer->GetGPUVirtualAddress());
```



结构缓冲区创建时不需要指定每个结构体的大小，结构化缓冲区数据以字节形式发送给显存，GPU会根据HLSL中声明的结构体的内存布局，从字节流中解析数据

```
struct InstanceData
{
    float4x4 World;        // 64 字节，16 字节对齐
    float4x4 TexTransform; // 64 字节，16 字节对齐
    uint     MaterialIndex; // 4 字节
    uint     InstPad0;     // 4 字节 (填充到 16 字节边界)
    uint     InstPad1;     // 4 字节
    uint     InstPad2;     // 4 字节
    // 总大小：144 字节，16 字节对齐
};

//声明每个单元为InstanceData
StructuredBuffer<InstanceData> gInstanceData : register(t0, space1);
```



结构缓冲区最大的优势是可以在shader中动态索引，获取相应数据。因此可以批量发送大量数据给GPU，一次性绑定，避免频繁的状态切换。在实例化绘制，compute shader等场景中很有优势。



结构化缓冲区还支持写入：

将资源状态转化为D3D12_RESOURCE_STATE_UNORDERED_ACCESS，在hlsl中声明为

```
RWStructuredBuffer<InstanceData> gInstanceData : register(t0, space1);
```

可对结构化缓冲区进行写入





问题：

结构化缓冲区

